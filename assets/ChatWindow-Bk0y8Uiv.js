import{c as k,q as l,i as R,k as P,r as g,j as e,Q as _,J as A,X as z,a3 as B}from"./index-fc28AEb_.js";import{S as O}from"./send-B_Vd5b5F.js";/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]],F=k("check-check",W);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]],Y=k("maximize-2",J);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=[["path",{d:"m14 10 7-7",key:"oa77jy"}],["path",{d:"M20 10h-6V4",key:"mjg0md"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M4 14h6v6",key:"rmj7iw"}]],G=k("minimize-2",K),L=async s=>{try{return(await l(`/marketplace/chats?userId=${s}`)).chats||[]}catch(t){return console.error("Error fetching user chats:",t),[]}},te=async(s,t,n,a,c,m,u,h)=>{try{const d=await l("/marketplace/chats",{method:"POST",body:JSON.stringify({requesterId:s,requesterName:t,requesterAvatar:n,sellerId:a,sellerName:c,sellerAvatar:m,projectId:u,projectTitle:h})});return{chatId:d.chatId,status:d.status,isNew:d.isNew||!1}}catch(d){throw console.error("Error creating/getting chat:",d),d}},V=async(s,t,n,a,c)=>{try{await l(`/marketplace/chats/${s}/messages`,{method:"POST",body:JSON.stringify({senderId:t,senderName:n,content:a,recipientId:c})})}catch(m){throw console.error("Error sending message:",m),m}},H=async s=>{try{return((await l(`/marketplace/chats/${s}/messages`)).messages||[]).map(a=>({...a,id:a.id||a._id,timestamp:new Date(a.timestamp)}))}catch(t){return console.error("Error fetching messages:",t),[]}},Q=async(s,t)=>{try{await l(`/marketplace/chats/${s}/read`,{method:"POST",body:JSON.stringify({userId:t})})}catch(n){console.error("Error marking messages as read:",n)}},X=(s,t)=>{const n=async()=>{const c=await L(s);t(c)};n();const a=setInterval(n,15e3);return()=>clearInterval(a)},Z=(s,t)=>{const n=async()=>{const c=await H(s);t(c)};n();const a=setInterval(n,1e4);return()=>clearInterval(a)},re=async s=>{try{await l(`/marketplace/chats/${s}/accept`,{method:"POST"})}catch(t){throw console.error("Error accepting chat request:",t),t}},ae=async s=>{try{await l(`/marketplace/chats/${s}/reject`,{method:"POST"})}catch(t){throw console.error("Error rejecting chat request:",t),t}},ne=(s,t)=>{const n=async()=>{try{const u=((await l(`/marketplace/chats/pending?userId=${s}`)).requests||[]).map(h=>({...h,id:h.id||h._id,lastMessageTime:new Date(h.lastMessageTime)}));t(u)}catch(c){console.error("Error fetching pending requests:",c),t([])}};n();const a=setInterval(n,1e4);return()=>clearInterval(a)},oe=(s,t)=>X(s,t),ce=async s=>{try{const t=s?`/marketplace/chats/debug?userId=${s}`:"/marketplace/chats/debug";return await l(t)}catch(t){return console.error("Error debugging chat system:",t),{error:"Debug failed"}}};function ie({chat:s,isOpen:t,onClose:n}){const{user:a}=R(),{userprofile:c,avatrUrl:m}=P(),[u,h]=g.useState([]),[d,N]=g.useState(""),[p,C]=g.useState(!1),[f,T]=g.useState(!1),S=g.useRef(null),j=s.participants.find(r=>r!==a?.id)||"",y=s.participantNames[j]||"User",w=s.participantAvatars[j]||"",D=m||s.participantAvatars[a?.id||""]||"";g.useEffect(()=>{if(!t||!s.id){console.log("ChatWindow: Not open or no chat id",{isOpen:t,chatId:s.id});return}console.log("ChatWindow: Subscribing to messages for chat:",s.id);const r=Z(s.id,i=>{console.log("ChatWindow: Received messages:",i.length,i),h(i),a?.id&&Q(s.id,a.id)});return()=>r()},[t,s.id,a?.id]),g.useEffect(()=>{E()},[u]);const E=()=>{S.current?.scrollIntoView({behavior:"smooth"})},I=async()=>{if(!(!d.trim()||!a?.id||p)){console.log("ChatWindow: Sending message to chat:",s.id),C(!0);try{await V(s.id,a.id,c?.name||"User",d,j),N(""),console.log("ChatWindow: Message sent successfully")}catch(r){console.error("ChatWindow: Error sending message:",r)}finally{C(!1)}}},U=r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),I())},q=r=>new Intl.DateTimeFormat("en-US",{hour:"numeric",minute:"numeric",hour12:!0}).format(r),$=r=>{const i=new Date,o=new Date(i);return o.setDate(o.getDate()-1),r.toDateString()===i.toDateString()?"Today":r.toDateString()===o.toDateString()?"Yesterday":new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",year:r.getFullYear()!==i.getFullYear()?"numeric":void 0}).format(r)},b=[];return u.forEach(r=>{const i=$(r.timestamp),o=b[b.length-1];o&&o.date===i?o.messages.push(r):b.push({date:i,messages:[r]})}),e.jsx(_,{children:t&&e.jsxs(A.div,{initial:{opacity:0,y:100,scale:.9},animate:{opacity:1,y:0,scale:1,height:f?"64px":"500px"},exit:{opacity:0,y:100,scale:.9},className:"fixed bottom-4 right-4 w-96 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col z-50 overflow-hidden",children:[e.jsxs("div",{className:"p-3 flex items-center justify-between",style:{background:"linear-gradient(135deg, #00ADB5 0%, #00d4ff 100%)"},children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsxs("div",{className:"relative",children:[w?e.jsx("img",{src:w,alt:y,className:"w-10 h-10 rounded-full border-2 border-white object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded-full border-2 border-white flex items-center justify-center text-white font-bold text-lg",style:{backgroundColor:"rgba(255,255,255,0.3)"},children:y.charAt(0).toUpperCase()}),e.jsx("span",{className:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-white truncate",children:y}),e.jsx("p",{className:"text-xs text-white/80 truncate",children:s.projectTitle})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>T(!f),className:"text-white hover:bg-white/20 p-2 rounded-full transition-colors",children:f?e.jsx(Y,{className:"w-5 h-5"}):e.jsx(G,{className:"w-5 h-5"})}),e.jsx("button",{onClick:n,className:"text-white hover:bg-white/20 p-2 rounded-full transition-colors",children:e.jsx(z,{className:"w-5 h-5"})})]})]}),!f&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-2",style:{background:"linear-gradient(180deg, #e5ddd5 0%, #d5c9be 100%)"},children:[u.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg px-4 py-3 inline-block shadow-sm",children:e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"ðŸ‘‹ Say hello! Start the conversation."})})}):b.map((r,i)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex justify-center my-3",children:e.jsx("span",{className:"bg-white/90 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs px-3 py-1 rounded-full shadow-sm",children:r.date})}),r.messages.map((o,M)=>{const x=o.senderId===a?.id,v=M===0||r.messages[M-1]?.senderId!==o.senderId;return e.jsxs(A.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`flex items-end gap-2 ${x?"justify-end":"justify-start"}`,children:[!x&&e.jsx("div",{className:"w-7 h-7 flex-shrink-0",children:v&&(w?e.jsx("img",{src:w,alt:y,className:"w-7 h-7 rounded-full object-cover"}):e.jsx("div",{className:"w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold",style:{backgroundColor:"#00ADB5"},children:y.charAt(0).toUpperCase()}))}),e.jsxs("div",{className:`max-w-[70%] rounded-lg px-3 py-2 shadow-sm relative ${x?"bg-[#dcf8c6] dark:bg-[#005c4b] text-gray-900 dark:text-white rounded-br-none":"bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-bl-none"}`,children:[!x&&v&&e.jsx("p",{className:"text-xs font-semibold mb-1",style:{color:"#00ADB5"},children:o.senderName}),e.jsx("p",{className:"text-sm break-words whitespace-pre-wrap",children:o.message}),e.jsxs("div",{className:"flex items-center justify-end gap-1 mt-1",children:[e.jsx("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:q(o.timestamp)}),x&&(o.read?e.jsx(F,{className:"w-4 h-4 text-blue-500"}):e.jsx(B,{className:"w-4 h-4 text-gray-400"}))]})]}),x&&e.jsx("div",{className:"w-7 h-7 flex-shrink-0",children:v&&(D?e.jsx("img",{src:D,alt:"You",className:"w-7 h-7 rounded-full object-cover"}):e.jsx("div",{className:"w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold",style:{backgroundColor:"#00ADB5"},children:(c?.name||"U").charAt(0).toUpperCase()}))})]},o.id)})]},i)),e.jsx("div",{ref:S})]}),e.jsx("div",{className:"p-3 bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:d,onChange:r=>N(r.target.value),onKeyPress:U,placeholder:"Type a message...",className:"flex-1 px-4 py-2.5 border-0 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#00ADB5] shadow-sm",disabled:p}),e.jsx("button",{onClick:I,disabled:!d.trim()||p,className:"w-10 h-10 rounded-full text-white flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 shadow-md",style:{backgroundColor:"#00ADB5"},children:p?e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(O,{className:"w-5 h-5"})})]})})]})]})})}export{ie as C,re as a,oe as b,te as c,ce as d,ae as r,ne as s};
